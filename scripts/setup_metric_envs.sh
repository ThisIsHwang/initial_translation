#!/usr/bin/env bash
set -euo pipefail

if ! command -v uv >/dev/null 2>&1; then
  echo "uv is required. Install uv first." >&2
  exit 1
fi

ROOT_DIR=$(cd "$(dirname "$0")/.." && pwd)
ROOT_URL="file://$ROOT_DIR"

ENV_ROOT="${ENV_ROOT:-.uv}"
ENV_COMET="${ENV_COMET:-$ENV_ROOT/comet}"
ENV_METRICX="${ENV_METRICX:-$ENV_ROOT/metricx}"
ENV_BLEU="${ENV_BLEU:-$ENV_ROOT/bleu}"
ENV_FILE="${METRIC_ENV_FILE:-$ENV_ROOT/metric_envs.env}"
ENV_GEN="${ENV_GEN:-$ENV_ROOT/gen}"
ENV_ALIGN="${ENV_ALIGN:-$ENV_ROOT/align}"
ENV_PIPELINE_FILE="${PIPELINE_ENV_FILE:-$ENV_ROOT/pipeline_envs.env}"
METRICX_PYTHON="${METRICX_PYTHON:-3.11}"

# Optional extra pins (comma-separated)
COMET_EXTRA_DEPS="${COMET_EXTRA_DEPS:-}"
# MetricX env pins (override with METRICX_EXTRA_DEPS if needed)
METRICX_EXTRA_DEPS="${METRICX_EXTRA_DEPS:-transformers[torch]==4.30.2,tokenizers==0.13.3,sentencepiece==0.1.99,protobuf==3.20.3,numpy==1.26.4,datasets==2.21.0,accelerate==1.12.0,pyarrow==15.0.2}"
BLEU_EXTRA_DEPS="${BLEU_EXTRA_DEPS:-}"
GEN_EXTRA_DEPS="${GEN_EXTRA_DEPS:-}"
ALIGN_EXTRA_DEPS="${ALIGN_EXTRA_DEPS:-}"

write_project() {
  local dir="$1"
  local name="$2"
  local extra="$3"
  local extra_deps="$4"
  local pkg_name
  pkg_name=$(echo "$name" | tr '-' '_' | tr '.' '_')
  local evalmt_dep="evalmt @ $ROOT_URL"
  if [ -n "$extra" ]; then
    evalmt_dep="evalmt[$extra] @ $ROOT_URL"
  fi
  mkdir -p "$dir"
  mkdir -p "$dir/src/$pkg_name"
  : > "$dir/src/$pkg_name/__init__.py"
  cat > "$dir/pyproject.toml" <<EOF
[build-system]
requires = ["hatchling>=1.25.0"]
build-backend = "hatchling.build"

[project]
name = "$name"
version = "0.0.0"
dependencies = [
EOF
  echo "  \"${evalmt_dep}\"," >> "$dir/pyproject.toml"
  if [ -n "$extra_deps" ]; then
    IFS=',' read -r -a dep_list <<< "$extra_deps"
    for dep in "${dep_list[@]}"; do
      dep=$(echo "$dep" | xargs)
      if [ -n "$dep" ]; then
        echo "  \"${dep}\"," >> "$dir/pyproject.toml"
      fi
    done
  fi
  cat >> "$dir/pyproject.toml" <<EOF
]

[tool.hatch.metadata]
allow-direct-references = true

[tool.hatch.build.targets.wheel]
packages = ["src/$pkg_name"]
EOF
}

sync_project() {
  local dir="$1"
  local py="${2:-}"
  if [ -n "$py" ]; then
    echo "==> uv sync --project $dir --python $py"
    uv sync --project "$dir" --python "$py"
  else
    echo "==> uv sync --project $dir"
    uv sync --project "$dir"
  fi
}

echo "Setting up metric envs under $ENV_ROOT"
write_project "$ENV_COMET" "evalmt-comet-env" "comet" "$COMET_EXTRA_DEPS"
# MetricX env intentionally uses base evalmt (no extras) to avoid transformers conflicts.
write_project "$ENV_METRICX" "evalmt-metricx-env" "" "$METRICX_EXTRA_DEPS"
write_project "$ENV_BLEU" "evalmt-bleu-env" "bleu" "$BLEU_EXTRA_DEPS"
write_project "$ENV_GEN" "evalmt-gen-env" "" "$GEN_EXTRA_DEPS"
write_project "$ENV_ALIGN" "evalmt-align-env" "" "$ALIGN_EXTRA_DEPS"

sync_project "$ENV_COMET"
sync_project "$ENV_METRICX" "$METRICX_PYTHON"
sync_project "$ENV_BLEU"
sync_project "$ENV_GEN"
sync_project "$ENV_ALIGN"

cat > "$ENV_FILE" <<EOF
# Auto-generated by scripts/setup_metric_envs.sh
: "\${METRIC_UV_PROJECT_COMET:=$ENV_COMET}"
: "\${METRIC_UV_PROJECT_METRICX:=$ENV_METRICX}"
: "\${METRIC_UV_PROJECT_BLEU:=$ENV_BLEU}"
: "\${METRIC_UV_PROJECTS_REQUIRED:=1}"
export METRIC_UV_PROJECT_COMET METRIC_UV_PROJECT_METRICX METRIC_UV_PROJECT_BLEU METRIC_UV_PROJECTS_REQUIRED
EOF

cat > "$ENV_PIPELINE_FILE" <<EOF
# Auto-generated by scripts/setup_metric_envs.sh
: "\${UV_PROJECT_GEN:=$ENV_GEN}"
: "\${UV_PROJECT_ALIGN:=$ENV_ALIGN}"
export UV_PROJECT_GEN UV_PROJECT_ALIGN
EOF

echo "âœ… Metric envs ready."
echo "Env file: $ENV_FILE"
echo "Tip: source $ENV_FILE"
echo "Pipeline env file: $ENV_PIPELINE_FILE"
